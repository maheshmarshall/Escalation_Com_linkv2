<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escalation Com Link Processor</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom font for a clean look */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Style for the file drop zone on drag over */
        .dragover {
            background-color: #eef2ff; /* Tailwind's indigo-50 */
            border-color: #6366f1; /* Tailwind's indigo-500 */
        }
        /* Fade-in animation for UI elements */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <!-- SheetJS library for Excel file parsing and writing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg border border-gray-200">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Escalation Com Link Processor</h1>

        <!-- File Upload Section with Drag and Drop -->
        <div id="dropZone" class="mb-6 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 transition-colors duration-300">
            <div class="flex flex-col items-center justify-center">
                <svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                </svg>
                <p class="mt-2 text-sm text-gray-600">
                    <span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop
                </p>
                <p class="text-xs text-gray-500">Excel or CSV (MAX. 20MB)</p>
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" class="hidden">
                <p id="fileNameDisplay" class="mt-2 text-sm font-medium text-gray-800"></p>
            </div>
        </div>

        <!-- Process Button -->
        <button id="processButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="buttonText">Process File</span>
        </button>

        <!-- Message Box for notifications -->
        <div id="messageBox" class="mt-6 p-4 rounded-lg text-sm hidden" role="alert"></div>

        <!-- Download Area -->
        <div id="downloadArea" class="mt-6 hidden flex-col space-y-4">
            <a id="downloadCsvLink" href="#" class="w-full inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                Download as CSV
            </a>
            <a id="downloadExcelLink" href="#" class="w-full inline-flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                Download as Excel
            </a>
        </div>
    </div>

    <script>
        // Get references to HTML elements
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const messageBox = document.getElementById('messageBox');
        const downloadArea = document.getElementById('downloadArea');
        const downloadCsvLink = document.getElementById('downloadCsvLink');
        const downloadExcelLink = document.getElementById('downloadExcelLink');
        const dropZone = document.getElementById('dropZone');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('buttonText');

        // Define the maximum file size in bytes (20MB)
        const MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024;

        // Variables to store processed data and original headers
        let processedDataRows = [];
        let originalHeaders = [];
        let currentFile = null;

        // --- Drag and Drop Logic ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            currentFile = file;
            fileNameDisplay.textContent = file.name;
        }

        // --- UI Functions ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'mt-6 p-4 rounded-lg text-sm fade-in';
            const colors = {
                error: ['bg-red-50', 'text-red-800'],
                success: ['bg-green-50', 'text-green-800'],
                info: ['bg-blue-50', 'text-blue-800'],
            };
            messageBox.classList.add(...(colors[type] || colors.info));
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function toggleProcessingState(isProcessing) {
            processButton.disabled = isProcessing;
            if (isProcessing) {
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Processing...';
            } else {
                spinner.classList.add('hidden');
                buttonText.textContent = 'Process File';
            }
        }

        function getTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
        }

        // --- Download Functions ---
        function setupCsvDownload() {
            const csvContent = [originalHeaders, ...processedDataRows]
                .map(row => row.map(cell => {
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            downloadCsvLink.href = url;
            downloadCsvLink.download = `Escalation_Com_Link_${getTimestamp()}.csv`;
        }

        function createPivotData() {
            const headerMap = new Map(originalHeaders.map((h, i) => [h, i]));
            const customerCodeIndex = headerMap.get('CustomerCode');
            const contractNoIndex = headerMap.get('ContractNo'); // New
            const newAmountIndex = headerMap.get('NewAmountInclVAT');
            const yearIndex = headerMap.get('Year');

            const pivotAggregates = new Map();
            const uniqueCustomers = new Set();
            let grandTotal = 0;

            for (const row of processedDataRows) {
                const customerCode = row[customerCodeIndex];
                const contractNo = row[contractNoIndex]; // New
                const year = row[yearIndex];
                const amount = parseFloat(row[newAmountIndex]) || 0;
                
                if (!customerCode || !contractNo || !year) continue; // Updated check
                uniqueCustomers.add(customerCode);
                grandTotal += amount;
                const key = `${customerCode}|${contractNo}|${year}`; // Updated key
                pivotAggregates.set(key, (pivotAggregates.get(key) || 0) + amount);
            }

            const sortedAggregates = Array.from(pivotAggregates.entries()).sort((a, b) => {
                const [codeA, contractA, yearA] = a[0].split('|'); // Updated destructuring
                const [codeB, contractB, yearB] = b[0].split('|'); // Updated destructuring
                if (yearA !== yearB) return yearB - yearA;
                if (codeA !== codeB) return codeA.localeCompare(codeB);
                return String(contractA).localeCompare(String(contractB));
            });

            const pivotData = [['CustomerCode', 'ContractNo', 'Year', 'Sum of NewAmountInclVAT']]; // Updated header
            sortedAggregates.forEach(([key, sum]) => {
                const [customerCode, contractNo, year] = key.split('|'); // Updated destructuring
                pivotData.push([customerCode, contractNo, year, sum]); // Updated row
            });
            
            const summaryData = [
                ['Summary', ''],
                ['Total Unique Customers', uniqueCustomers.size],
                ['Grand Total (NewAmountInclVAT)', grandTotal.toFixed(2)]
            ];

            // Add an empty column for spacing in the pivot sheet
            pivotData.forEach(row => row.push('')); 

            // Merge summary data into the pivot data array for side-by-side display
            for (let i = 0; i < summaryData.length; i++) {
                const summaryRow = summaryData[i];
                if (pivotData[i]) {
                    pivotData[i].push(...summaryRow);
                } else {
                    const padding = new Array(pivotData[0].length - summaryRow.length).fill('');
                    pivotData.push([...padding, ...summaryRow]);
                }
            }
            return pivotData;
        }

        function setupExcelDownload() {
            const mainWs = XLSX.utils.aoa_to_sheet([originalHeaders, ...processedDataRows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, mainWs, "ProcessedData");

            const pivotData = createPivotData();
            const pivotWs = XLSX.utils.aoa_to_sheet(pivotData);
            XLSX.utils.book_append_sheet(wb, pivotWs, "Piv");
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            downloadExcelLink.href = URL.createObjectURL(blob);
            downloadExcelLink.download = `Escalation_Com_Link_${getTimestamp()}.xlsx`;
        }

        // --- Main Processing Logic ---
        processButton.addEventListener('click', () => {
            hideMessage();
            downloadArea.classList.add('hidden');
            processedDataRows = [];
            originalHeaders = [];

            if (!currentFile) {
                showMessage('Please select a file first.', 'error');
                return;
            }

            if (currentFile.size > MAX_FILE_SIZE_BYTES) {
                showMessage(`File size exceeds the limit of ${MAX_FILE_SIZE_BYTES / (1024 * 1024)}MB.`, 'error');
                return;
            }

            const fileExtension = currentFile.name.split('.').pop().toLowerCase();
            const isExcel = ['xlsx', 'xls'].includes(fileExtension);

            toggleProcessingState(true);

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const fileData = e.target.result;
                    const workbook = isExcel ? XLSX.read(new Uint8Array(fileData), { type: 'array' }) : XLSX.read(fileData, { type: 'string' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const dataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                    if (dataArray.length < 2) {
                        throw new Error('The file is empty or contains only a header.');
                    }

                    originalHeaders = dataArray[0].map(h => String(h).trim());
                    if (!originalHeaders.includes('Year')) {
                        originalHeaders.push('Year');
                    }
                    const headerIndexMap = new Map(originalHeaders.map((h, i) => [h, i]));

                    // Updated required columns check
                    ['ChargeType', 'ContractStartDate', 'CustomerCode', 'ContractNo', 'NewAmountInclVAT'].forEach(h => {
                        if (!headerIndexMap.has(h)) throw new Error(`Missing required column: "${h}".`);
                    });
                    
                    const chargeTypeIndex = headerIndexMap.get('ChargeType');
                    const contractStartDateIndex = headerIndexMap.get('ContractStartDate');
                    const yearColIndex = headerIndexMap.get('Year');
                    const expectedColumnCount = originalHeaders.length;
                    
                    // Define the charge types to be excluded
                    const excludedChargeTypes = ['14', '32', '50', '68', '98'];

                    const dataRows = dataArray.slice(1);
                    for (const row of dataRows) {
                        // Check if the current row's charge type should be excluded
                        if (excludedChargeTypes.includes(String(row[chargeTypeIndex]).trim())) {
                            continue;
                        }

                        const currentRow = [...row];
                        const dateValue = String(currentRow[contractStartDateIndex]).trim();
                        let year = '';
                        if (dateValue && dateValue.length >= 4) {
                             // Try parsing as a full date first
                            const parsedYear = new Date(dateValue).getFullYear();
                            // Fallback to substring if parsing fails (for formats like '2023-01')
                            year = !isNaN(parsedYear) ? parsedYear : dateValue.substring(0, 4);
                        }
                        
                        // Ensure the row has enough columns before setting the year
                        while (currentRow.length < yearColIndex) currentRow.push('');
                        currentRow[yearColIndex] = year;

                        // Pad or truncate the row to match the header length
                        while (currentRow.length < expectedColumnCount) currentRow.push('');
                        if (currentRow.length > expectedColumnCount) currentRow.length = expectedColumnCount;

                        processedDataRows.push(currentRow);
                    }

                    if (processedDataRows.length === 0) {
                        showMessage('Processing complete, but no data rows remained after filtering.', 'info');
                        toggleProcessingState(false); // Ensure button is re-enabled
                        return;
                    }

                    setupCsvDownload();
                    setupExcelDownload();
                    downloadArea.classList.remove('hidden');
                    downloadArea.classList.add('fade-in');
                    showMessage('File processed successfully! You can now download the new file.', 'success');

                } catch (error) {
                    console.error('Error processing file:', error);
                    showMessage(error.message || 'An error occurred during processing. Please check the file format.', 'error');
                } finally {
                    toggleProcessingState(false);
                }
            };

            reader.onerror = () => {
                showMessage('Failed to read the file. Please try again.', 'error');
                toggleProcessingState(false);
            };

            isExcel ? reader.readAsArrayBuffer(currentFile) : reader.readAsText(currentFile);
        });
    </script>
</body>
</html>
